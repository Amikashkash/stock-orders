<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×§×•×™ ×”×–×× ×•×ª ×¨×™×§×•×ª</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-3xl font-bold mb-6 text-center text-red-600">âš ï¸ × ×™×§×•×™ ×”×–×× ×•×ª ×¨×™×§×•×ª</h1>
        
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
            <p class="text-yellow-700 font-bold">××–×”×¨×”!</p>
            <p class="text-yellow-600 text-sm">×›×œ×™ ×–×” ×™××—×§ ×”×–×× ×•×ª ×¨×™×§×•×ª (draft) ××”××¢×¨×›×ª. ×¤×¢×•×œ×” ×–×• ××™× ×” × ×™×ª× ×ª ×œ×‘×™×˜×•×œ.</p>
        </div>

        <div id="login-section" class="mb-6">
            <h2 class="text-xl font-bold mb-4">×”×ª×—×‘×¨×•×ª</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">××™××™×™×œ</label>
                    <input type="email" id="email" class="w-full border rounded px-3 py-2" placeholder="your@email.com">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">×¡×™×¡××”</label>
                    <input type="password" id="password" class="w-full border rounded px-3 py-2" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <button id="login-btn" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">
                    ×”×ª×—×‘×¨
                </button>
            </div>
        </div>

        <div id="cleanup-section" class="hidden">
            <div class="mb-6">
                <h2 class="text-xl font-bold mb-4">×¡×˜×˜×™×¡×˜×™×§×•×ª</h2>
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div class="bg-blue-50 p-4 rounded">
                        <div class="text-2xl font-bold text-blue-600" id="total-orders">-</div>
                        <div class="text-sm text-gray-600">×¡×”"×› ×”×–×× ×•×ª</div>
                    </div>
                    <div class="bg-red-50 p-4 rounded">
                        <div class="text-2xl font-bold text-red-600" id="draft-orders">-</div>
                        <div class="text-sm text-gray-600">×”×–×× ×•×ª draft</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded">
                        <div class="text-2xl font-bold text-green-600" id="deleted-orders">0</div>
                        <div class="text-sm text-gray-600">× ××—×§×•</div>
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <h2 class="text-xl font-bold mb-4">××¤×©×¨×•×™×•×ª × ×™×§×•×™</h2>
                <div class="space-y-3">
                    <label class="flex items-center space-x-3 space-x-reverse">
                        <input type="checkbox" id="delete-drafts" checked class="form-checkbox h-5 w-5 text-blue-600">
                        <span>××—×§ ×”×–×× ×•×ª ×¢× ×¡×˜×˜×•×¡ "draft"</span>
                    </label>
                    <label class="flex items-center space-x-3 space-x-reverse">
                        <input type="checkbox" id="delete-empty" checked class="form-checkbox h-5 w-5 text-blue-600">
                        <span>××—×§ ×”×–×× ×•×ª ×œ×œ× ×¤×¨×™×˜×™× (items ×¨×™×§)</span>
                    </label>
                </div>
            </div>

            <div class="mb-6">
                <button id="scan-btn" class="w-full bg-blue-500 text-white py-3 rounded hover:bg-blue-600 font-bold mb-2">
                    ğŸ” ×¡×¨×•×§ ×”×–×× ×•×ª
                </button>
                <button id="cleanup-btn" class="w-full bg-red-500 text-white py-3 rounded hover:bg-red-600 font-bold disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    ğŸ—‘ï¸ ××—×§ ×”×–×× ×•×ª ×¨×™×§×•×ª
                </button>
            </div>

            <div id="log-section" class="bg-gray-50 rounded p-4 max-h-96 overflow-y-auto">
                <h3 class="font-bold mb-2">×œ×•×’ ×¤×¢×•×œ×•×ª</h3>
                <div id="log" class="text-sm space-y-1 font-mono"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCdAYpf-yICDIHVaqZtRhTk14xV5IfewF4",
            authDomain: "stock-orders-75be0.firebaseapp.com",
            projectId: "stock-orders-75be0",
            storageBucket: "stock-orders-75be0.appspot.com",
            messagingSenderId: "637582925650",
            appId: "1:637582925650:web:23e1626b00db6eca30e48b",
            measurementId: "G-71PT1GXC8R"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let ordersToDelete = [];

        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString('he-IL');
            const colors = {
                info: 'text-blue-600',
                success: 'text-green-600',
                error: 'text-red-600',
                warning: 'text-yellow-600'
            };
            logEl.innerHTML += `<div class="${colors[type]}">[${timestamp}] ${message}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        // Login
        document.getElementById('login-btn').addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                await signInWithEmailAndPassword(auth, email, password);
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('cleanup-section').classList.remove('hidden');
                log('×”×ª×—×‘×¨×ª ×‘×”×¦×œ×—×”', 'success');
            } catch (error) {
                alert('×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª: ' + error.message);
            }
        });

        // Scan for orders
        document.getElementById('scan-btn').addEventListener('click', async () => {
            log('××ª×—×™×œ ×œ×¡×¨×•×§ ×”×–×× ×•×ª...', 'info');
            ordersToDelete = [];
            
            const deleteDrafts = document.getElementById('delete-drafts').checked;
            const deleteEmpty = document.getElementById('delete-empty').checked;

            try {
                const ordersSnapshot = await getDocs(collection(db, "orders"));
                const totalOrders = ordersSnapshot.size;
                let draftCount = 0;
                
                document.getElementById('total-orders').textContent = totalOrders;

                for (const orderDoc of ordersSnapshot.docs) {
                    const orderData = orderDoc.data();
                    const orderId = orderDoc.id;
                    let shouldDelete = false;

                    // Check if it's a draft
                    if (deleteDrafts && orderData.status === 'draft') {
                        shouldDelete = true;
                        draftCount++;
                        log(`××¦× draft: ${orderId}`, 'warning');
                    }

                    // Check if it has no items
                    if (deleteEmpty) {
                        const itemsSnapshot = await getDocs(collection(db, "orders", orderId, "orderItems"));
                        if (itemsSnapshot.empty && (!orderData.items || orderData.items.length === 0)) {
                            shouldDelete = true;
                            log(`××¦× ×”×–×× ×” ×¨×™×§×”: ${orderId} (×¡×˜×˜×•×¡: ${orderData.status || '×œ× ×™×“×•×¢'})`, 'warning');
                        }
                    }

                    if (shouldDelete) {
                        ordersToDelete.push({
                            id: orderId,
                            displayId: orderData.displayId || orderId.substring(0, 8),
                            status: orderData.status,
                            createdAt: orderData.createdAt
                        });
                    }
                }

                document.getElementById('draft-orders').textContent = draftCount;
                log(`×¡×¨×™×§×” ×”×•×©×œ××”: × ××¦××• ${ordersToDelete.length} ×”×–×× ×•×ª ×œ××—×™×§×”`, 'success');
                
                if (ordersToDelete.length > 0) {
                    document.getElementById('cleanup-btn').disabled = false;
                    log(`×œ×—×¥ ×¢×œ ×›×¤×ª×•×¨ "××—×§ ×”×–×× ×•×ª ×¨×™×§×•×ª" ×›×“×™ ×œ×”××©×™×š`, 'info');
                } else {
                    log('×œ× × ××¦××• ×”×–×× ×•×ª ×œ××—×™×§×”', 'info');
                }

            } catch (error) {
                log('×©×’×™××” ×‘×¡×¨×™×§×”: ' + error.message, 'error');
            }
        });

        // Cleanup orders
        document.getElementById('cleanup-btn').addEventListener('click', async () => {
            if (!confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ${ordersToDelete.length} ×”×–×× ×•×ª?\n\n×¤×¢×•×œ×” ×–×• ××™× ×” × ×™×ª× ×ª ×œ×‘×™×˜×•×œ!`)) {
                return;
            }

            document.getElementById('cleanup-btn').disabled = true;
            document.getElementById('scan-btn').disabled = true;
            let deletedCount = 0;

            log(`××ª×—×™×œ ××—×™×§×” ×©×œ ${ordersToDelete.length} ×”×–×× ×•×ª...`, 'info');

            for (const order of ordersToDelete) {
                try {
                    // Delete the order
                    await deleteDoc(doc(db, "orders", order.id));
                    deletedCount++;
                    document.getElementById('deleted-orders').textContent = deletedCount;
                    log(`âœ“ × ××—×§: ${order.displayId} (${order.id})`, 'success');
                } catch (error) {
                    log(`âœ— ×©×’×™××” ×‘××—×™×§×ª ${order.displayId}: ${error.message}`, 'error');
                }
            }

            log(`××—×™×§×” ×”×•×©×œ××”! × ××—×§×• ${deletedCount} ××ª×•×š ${ordersToDelete.length} ×”×–×× ×•×ª`, 'success');
            document.getElementById('scan-btn').disabled = false;
            ordersToDelete = [];
        });
    </script>
</body>
</html>
